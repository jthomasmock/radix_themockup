<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Thomas Mock" />


<title>Untitled</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="resources.html">Resources</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="https://twitter.com/thomas_mock">
    <span class="fa fa fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/jthomasmock">
    <span class="fa fa fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="index.xml">
    <span class="fa fa fa fa-rss"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Untitled</h1>
<h4 class="author">Thomas Mock</h4>
<h4 class="date">8/27/2020</h4>

</div>


<p>Many thanks to <a href="https://twitter.com/ChiefsAnalytics">Ethan Douglas</a> for sharing his heatmap passing charts on <a href="https://www.opensourcefootball.com/posts/2020-08-22-nfl-pass-location-visualization/">OpenSource Football</a>!</p>
<p>This is a similar walkthrough in R + <code>ggplot2</code>, but credit for both collecting the data and a lot of the general ideas are Ethan’s!</p>
<div id="load-everything" class="section level1">
<h1>Load Everything</h1>
<pre class="r"><code>library(tidyverse)
library(ggExtra)
library(patchwork)
library(paletteer)
library(scales)</code></pre>
<pre class="r"><code>pass_map_df &lt;- read_csv(&quot;https://raw.githubusercontent.com/ArrowheadAnalytics/next-gen-scrapy-2.0/master/pass_and_game_data.csv&quot;) %&gt;%
  na.omit() %&gt;%
  select(-X1)</code></pre>
<pre><code>## Warning: Missing column names filled in: &#39;X1&#39; [1]</code></pre>
<pre><code>## Parsed with column specification:
## cols(
##   .default = col_character(),
##   X1 = col_double(),
##   game_id = col_double(),
##   week.x = col_double(),
##   x_coord = col_double(),
##   y_coord = col_double(),
##   season = col_double(),
##   week.y = col_double(),
##   gameday = col_date(format = &quot;&quot;),
##   gametime = col_time(format = &quot;&quot;),
##   away_score = col_double(),
##   home_score = col_double(),
##   home_result = col_double()
## )</code></pre>
<pre><code>## See spec(...) for full column specifications.</code></pre>
<pre><code>## Warning: 2349 parsing failures.
##  row    col expected     actual                                                                                                     file
## 2050 week.x a double divisional &#39;https://raw.githubusercontent.com/ArrowheadAnalytics/next-gen-scrapy-2.0/master/pass_and_game_data.csv&#39;
## 2051 week.x a double divisional &#39;https://raw.githubusercontent.com/ArrowheadAnalytics/next-gen-scrapy-2.0/master/pass_and_game_data.csv&#39;
## 2052 week.x a double divisional &#39;https://raw.githubusercontent.com/ArrowheadAnalytics/next-gen-scrapy-2.0/master/pass_and_game_data.csv&#39;
## 2053 week.x a double divisional &#39;https://raw.githubusercontent.com/ArrowheadAnalytics/next-gen-scrapy-2.0/master/pass_and_game_data.csv&#39;
## 2054 week.x a double divisional &#39;https://raw.githubusercontent.com/ArrowheadAnalytics/next-gen-scrapy-2.0/master/pass_and_game_data.csv&#39;
## .... ...... ........ .......... ........................................................................................................
## See problems(...) for more details.</code></pre>
<pre class="r"><code>glimpse(pass_map_df)</code></pre>
<pre><code>## Rows: 49,758
## Columns: 23
## $ game_id     &lt;dbl&gt; 2017091004, 2017091004, 2017091004, 2017091004, 201709100…
## $ team        &lt;chr&gt; &quot;ARI&quot;, &quot;ARI&quot;, &quot;ARI&quot;, &quot;ARI&quot;, &quot;ARI&quot;, &quot;ARI&quot;, &quot;ARI&quot;, &quot;ARI&quot;, &quot;…
## $ week.x      &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
## $ name        &lt;chr&gt; &quot;Carson Palmer&quot;, &quot;Carson Palmer&quot;, &quot;Carson Palmer&quot;, &quot;Carso…
## $ pass_type   &lt;chr&gt; &quot;COMPLETE&quot;, &quot;COMPLETE&quot;, &quot;COMPLETE&quot;, &quot;COMPLETE&quot;, &quot;COMPLETE…
## $ x_coord     &lt;dbl&gt; 13.5, -13.7, 2.2, 23.9, -23.5, -4.4, 8.0, -19.0, -8.4, -1…
## $ y_coord     &lt;dbl&gt; -2.8, -4.4, 7.1, 10.0, 14.6, 5.3, 5.2, 18.0, 8.3, 12.4, -…
## $ game_id.y   &lt;chr&gt; &quot;2017_01_ARI_DET&quot;, &quot;2017_01_ARI_DET&quot;, &quot;2017_01_ARI_DET&quot;, …
## $ season      &lt;dbl&gt; 2017, 2017, 2017, 2017, 2017, 2017, 2017, 2017, 2017, 201…
## $ game_type   &lt;chr&gt; &quot;REG&quot;, &quot;REG&quot;, &quot;REG&quot;, &quot;REG&quot;, &quot;REG&quot;, &quot;REG&quot;, &quot;REG&quot;, &quot;REG&quot;, &quot;…
## $ week.y      &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
## $ gameday     &lt;date&gt; 2017-09-10, 2017-09-10, 2017-09-10, 2017-09-10, 2017-09-…
## $ weekday     &lt;chr&gt; &quot;Sunday&quot;, &quot;Sunday&quot;, &quot;Sunday&quot;, &quot;Sunday&quot;, &quot;Sunday&quot;, &quot;Sunday…
## $ gametime    &lt;time&gt; 13:00:00, 13:00:00, 13:00:00, 13:00:00, 13:00:00, 13:00:…
## $ away_team   &lt;chr&gt; &quot;ARI&quot;, &quot;ARI&quot;, &quot;ARI&quot;, &quot;ARI&quot;, &quot;ARI&quot;, &quot;ARI&quot;, &quot;ARI&quot;, &quot;ARI&quot;, &quot;…
## $ home_team   &lt;chr&gt; &quot;DET&quot;, &quot;DET&quot;, &quot;DET&quot;, &quot;DET&quot;, &quot;DET&quot;, &quot;DET&quot;, &quot;DET&quot;, &quot;DET&quot;, &quot;…
## $ away_score  &lt;dbl&gt; 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 2…
## $ home_score  &lt;dbl&gt; 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 3…
## $ home_result &lt;dbl&gt; 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 1…
## $ stadium     &lt;chr&gt; &quot;Ford Field&quot;, &quot;Ford Field&quot;, &quot;Ford Field&quot;, &quot;Ford Field&quot;, &quot;…
## $ location    &lt;chr&gt; &quot;Home&quot;, &quot;Home&quot;, &quot;Home&quot;, &quot;Home&quot;, &quot;Home&quot;, &quot;Home&quot;, &quot;Home&quot;, &quot;…
## $ roof        &lt;chr&gt; &quot;dome&quot;, &quot;dome&quot;, &quot;dome&quot;, &quot;dome&quot;, &quot;dome&quot;, &quot;dome&quot;, &quot;dome&quot;, &quot;…
## $ surface     &lt;chr&gt; &quot;fieldturf&quot;, &quot;fieldturf&quot;, &quot;fieldturf&quot;, &quot;fieldturf&quot;, &quot;fiel…</code></pre>
<div id="why-not-just-plot-the-points" class="section level2">
<h2>Why not just plot the points?</h2>
<p>We run the risk of overplotting by plotting just the points without thinking or adjusting any of the aesthetics.</p>
<p>Hadley Wickham in <a href="https://ggplot2-book.org/statistical-summaries.html#overplotting"><code>ggplot2</code>: Elegant Graphics for Data Analysis</a>:</p>
<blockquote>
<p>However, when the data is large, points will be often plotted on top of each other, obscuring the true relationship. In extreme cases, you will only be able to see the extent of the data, and any conclusions drawn from the graphic will be suspect. This problem is called <strong>overplotting</strong>.</p>
</blockquote>
<p>Hadley uses an example w/ 2000 data points, which already has a lot of overplotting due to a small sample x-y space. We have about 43,000 passes for this dataset, spread out over a relatively large space. We still need to be careful of overplotting though!</p>
<aside>
<p>from Data to Viz has another short article on <a href="https://www.data-to-viz.com/caveat/overplotting.html">Overplotting</a></p>
</aside>
<div id="fear-the-beard" class="section level3">
<h3>Fear the beard</h3>
<p>We can display our points with a quick <code>geom_point()</code> call but this returns a lot of overplotting albeit in a happy beard shape!</p>
<pre class="r"><code>pass_map_df %&gt;%
  ggplot(aes(x = x_coord, y = y_coord)) +
  geom_point()</code></pre>
<p><img src="pass-map_files/figure-html/sanity-check-1.png" width="384" /></p>
<p>We can add 90% transparency with <code>alpha = 0.1</code> and change the color to red, but this still leaves us with a difficulty parsing through the high vs medium pass locations. Passes around the 5 yard mark appear to be as common as at the 10 and even 15 yard mark in some cases! We can try to get at the data a bit close with <code>ggMarginal</code> from the <a href="https://github.com/daattali/ggExtra"><code>ggExtra</code></a> R package, which provides marginal histograms, box plots, or density plots.</p>
<pre class="r"><code>red_beard &lt;- pass_map_df %&gt;%
  ggplot(aes(x = x_coord, y = y_coord)) +
  geom_point(alpha = 0.1, color = &quot;red&quot;)

red_beard</code></pre>
<p><img src="pass-map_files/figure-html/unnamed-chunk-3-1.png" width="384" /></p>
<p>We can add some marginal plots to help out a bit, but that still doesn’t solve the problem of honing in on specific areas of interest that well.</p>
<pre class="r"><code># add density or histogram in the margins
ggMarginal(red_beard, type = &quot;density&quot;, fill = &quot;red&quot;)</code></pre>
<p><img src="pass-map_files/figure-html/marginal-plots-1.png" width="384" /></p>
<pre class="r"><code># add density or histogram in the margins
ggMarginal(red_beard, type = &quot;histogram&quot;, fill = &quot;red&quot;)</code></pre>
<p><img src="pass-map_files/figure-html/marginal-plots2-1.png" width="384" /></p>
</div>
<div id="alternatives-to-the-beard" class="section level3">
<h3>Alternatives to the beard</h3>
<p>Since we’re actually interested in the density/counts of observations at each x-y coordinate instead of plotting <em>each</em> individual point, we also have a few other tools in our toolbox! We can use <a href="https://ggplot2.tidyverse.org/reference/geom_hex.html"><code>geom_hex()</code></a> or <a href="https://ggplot2.tidyverse.org/reference/geom_bin2d.html"><code>geom_bin2d()</code></a>. Note that there are a few other methods such as <code>geom_raster()</code> which require you to provide your own “z” metric, and there are <code>stat_?</code> versions of each of these geoms for more custom calculations.</p>
<aside>
If you read the <code>ggplot2</code> + overplotting <a href="https://ggplot2-book.org/statistical-summaries.html#overplotting"><code>ggplot2</code> book chapter</a>, you can find more reproducible longer form examples and strategies with <code>geom_hex()</code> and <code>geom_bin2d()</code>.
</aside>
<pre class="r"><code>hex_plot &lt;- pass_map_df %&gt;%
  ggplot(aes(x = x_coord, y = y_coord)) +
  geom_hex(
    binwidth = c(1, 1)
  ) +
  scale_fill_gradient(low = &quot;red&quot;, high = &quot;yellow&quot;) +
  geom_hline(yintercept = c(0, 10), color = &quot;grey&quot;) +
  scale_y_continuous(breaks = seq(-10, 60, 5))

hex_plot</code></pre>
<p><img src="pass-map_files/figure-html/hex-plot-1.png" width="576" /></p>
<pre class="r"><code>bin2d &lt;- pass_map_df %&gt;%
  ggplot(aes(x = x_coord, y = y_coord)) +
  geom_bin2d(
    binwidth = c(1, 1)
  ) +
  scale_fill_gradient(low = &quot;red&quot;, high = &quot;yellow&quot;) +
  geom_hline(yintercept = c(0, 10), color = &quot;grey&quot;) +
  scale_y_continuous(breaks = seq(-10, 60, 5))

bin2d</code></pre>
<p><img src="pass-map_files/figure-html/hex-plot-2.png" width="576" /></p>
<p>We can now see that while there ARE passes all over the field, the majority are around the 2-7 yard mark with small but relatively dense pockets elsewhere. Passes are most frequently thrown at 4, 5 or 6 yards and ~68% of passes are thrown 10 yards or shorter.</p>
<pre class="r"><code># histogram of just Y coord
pass_map_df %&gt;%
  ggplot(aes(x = y_coord)) +
  geom_histogram(binwidth = 1) +
  geom_vline(xintercept = c(5)) +
  scale_x_continuous(breaks = seq(-10, 60, 5))</code></pre>
<p><img src="pass-map_files/figure-html/not-heatmaps-1.png" width="672" /></p>
<pre class="r"><code># calc some percentages
pass_by_y &lt;- pass_map_df %&gt;%
  mutate(y_rnd = round(y_coord, digits = 0)) %&gt;%
  count(y_rnd) %&gt;%
  mutate(
    total = sum(n),
    pct_total = n / total,
    roll_total = cumsum(pct_total)
  )

# ~35.6% of passes between 2-7 yards
pass_by_y %&gt;%
  filter(between(y_rnd, 2, 7)) %&gt;%
  summarize(pct = sum(pct_total))</code></pre>
<pre><code>## # A tibble: 1 x 1
##     pct
##   &lt;dbl&gt;
## 1 0.351</code></pre>
<pre class="r"><code># passes are most commonly thrown at 4-6 yards
# 68% of passes are thrown 10 yards or shorter
pass_by_y %&gt;%
  arrange(desc(pct_total))</code></pre>
<pre><code>## # A tibble: 68 x 5
##    y_rnd     n total pct_total roll_total
##    &lt;dbl&gt; &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;      &lt;dbl&gt;
##  1     4  3705 49758    0.0745      0.408
##  2     5  3420 49758    0.0687      0.477
##  3     6  3248 49758    0.0653      0.542
##  4     2  2774 49758    0.0557      0.282
##  5     3  2550 49758    0.0512      0.333
##  6     1  1894 49758    0.0381      0.226
##  7     0  1775 49758    0.0357      0.188
##  8     7  1771 49758    0.0356      0.578
##  9     8  1736 49758    0.0349      0.612
## 10    10  1642 49758    0.0330      0.672
## # … with 58 more rows</code></pre>
<p>Another major advantage of <code>geom_hex</code> or <code>geom_bin2d()</code> is they’re remarkably faster for big data than plotting <code>geom_point()</code> along with reducing the likelihood of overplotting! For a toy example of about 1.7 million points, <code>geom_hex()</code> executes in about 2 sec vs 20 sec with <code>geom_point()</code>, and then subsequent 30-60 sec to “draw” the output in the viewer of R/RStudio.</p>
</div>
</div>
<div id="d-density-of-smaller-data" class="section level2">
<h2>2D Density of “smaller” data</h2>
<p>So we’ve covered hex and rectangular 2d bins. To me, these are not as attractive for “small data” like we may see for individual QB plots. Let’s take Patrick Mahomes for example, he <em>only</em> has ~1,000 passes in this dataset. We can plot with a <code>geom_hex()</code> for each 1x1 yard chunk like we did before, but I honestly have trouble determining trends of where he likes to throw with that graphic.</p>
<pre class="r"><code>pass_map_df %&gt;%
  filter(str_detect(name, c(&quot;Mahomes&quot;))) %&gt;%
  ggplot(aes(x = x_coord, y = y_coord)) +
  geom_hex(binwidth = c(1, 1)) +
  scale_y_continuous(breaks = seq(-10, 60, 5))</code></pre>
<p><img src="pass-map_files/figure-html/mahomes-alone-1.png" width="576" /></p>
<p>We could always use larger bins, but if we’re just trying to see large trends we have another strategy in <a href="https://ggplot2.tidyverse.org/reference/geom_density_2d.html"><code>geom_density_2d()</code></a>.</p>
<blockquote>
<p>Perform a 2D kernel density estimation using <a href="https://rdrr.io/pkg/MASS/man/kde2d.html">MASS::kde2d()</a> and display the results with contours. This can be useful for dealing with overplotting. This is a 2D version of geom_density(). geom_density_2d() draws contour lines, and geom_density_2d_filled() draws filled contour bands.</p>
</blockquote>
<p>This essentially fits a polygon around the most frequent points by x/y coordinates, and then colors them according to density. x-y positions on the field and “z” is the density.</p>
<pre class="r"><code>pass_map_df %&gt;%
  filter(str_detect(name, c(&quot;Mahomes&quot;))) %&gt;%
  ggplot(aes(x = x_coord, y = y_coord)) +
  geom_density_2d_filled() +
  scale_y_continuous(breaks = seq(-10, 60, 5))</code></pre>
<p><img src="pass-map_files/figure-html/mahomes-2d-1.png" width="576" /></p>
<p>Now if we want to get even more clever, we can use this compare passing heatmaps of specific QBs. We can normalize across the facets, and drop the least frequent passes with specific breaks. We’ve binned into 10 specific breakpoints. By adding a horizontal line we can pretty clearly see that Carr’s most common passes are behind the 5 yard line, while Mahomes has passed beyond the 5 yard line more frequently.</p>
<pre class="r"><code>pass_map_df %&gt;%
  filter(str_detect(name, c(&quot;Mahomes|Derek Carr&quot;))) %&gt;%
  ggplot(aes(x = x_coord, y = y_coord)) +
  geom_density_2d_filled(
    aes(fill = ..level..),
    contour_var = &quot;ndensity&quot;, # normalize to each QBs total passes
    breaks = seq(0.1, 1.0, length.out = 10) # drop the lowest passes
  ) +
  scale_y_continuous(breaks = seq(-10, 60, 5)) +
  facet_wrap(~name) +
  geom_hline(yintercept = 5)</code></pre>
<p><img src="pass-map_files/figure-html/mahomes-compare-1.png" width="960" /></p>
<p>This is all well and good, but it’s not the prettiest piece of dataviz.</p>
<p>Thanks to <a href="https://twitter.com/ChiefsAnalytics">Ethan Douglas</a> and his post on <a href="https://www.opensourcefootball.com/posts/2020-08-22-nfl-pass-location-visualization/">OpenSourceFootball.com</a>, we have a good framework about how to approach building a NFL field as a graph.</p>
</div>
<div id="build-the-field" class="section level2">
<h2>Build the field</h2>
<pre class="r"><code>not_div_5 &lt;- function(x) {
  # select only elements of the vector not divisible by 5
  x[x %% 5 != 0]
}

center_df &lt;- tibble(
  x_coord = c(rep(-3.1, 60), rep(3.1, 60)),
  y_coord = seq(-14, 59, 1) %&gt;% rep(2) %&gt;% not_div_5(),
  text = &quot;--&quot;
)

# line labels
annotate_df &lt;- tibble(
  x_coord = c(12.88, -12.88) %&gt;% rep(each = 5),
  y_coord = seq(10, 50, 10) %&gt;% rep(2),
  text = seq(10, 50, 10) %&gt;% rep(2) %&gt;% str_replace(&quot;(.)(.)&quot;, &quot;\\1 \\2&quot;),
  rotation = c(90, 270) %&gt;% rep(each = 5)
)

# yardlines
yardline_df &lt;- tibble(
  y = seq(-15, 60, 5),
  yend = seq(-15, 60, 5),
  x = rep(-56 / 2, 16),
  xend = rep(56 / 2, 16)
)

# sidelines
sideline_df &lt;- tibble(
  y = c(-15.15, -15.15),
  yend = c(60.15, 60.15),
  x = c(-56 / 2, 56 / 2),
  xend = c(-56 / 2, 56 / 2)
)</code></pre>
<pre class="r"><code>ggplot(data = NULL, aes(x = x_coord, y = y_coord)) +
  coord_cartesian(
    xlim = c(-53.333 / 2, 53.333 / 2),
    ylim = c(-15, 60)
  ) +
  geom_text(
    data = annotate_df, aes(label = text, angle = rotation),
    color = &quot;black&quot;, size = 8
  ) +
  geom_segment(
    data = yardline_df, color = &quot;black&quot;, size = 1,
    aes(x = x, y = y, xend = xend, yend = yend)
  ) +
  geom_segment(
    x = -56 / 2, y = 0, xend = 56 / 2, yend = 0,
    color = &quot;blue&quot;, size = 1, alpha = 0.5
  ) +
  geom_segment(
    data = sideline_df, color = &quot;black&quot;, size = 2,
    aes(x = x, y = y, xend = xend, yend = yend)
  ) +
  geom_text(
    data = center_df,
    aes(label = text), color = &quot;black&quot;, vjust = 0.32
  ) +
  theme_void()</code></pre>
<p><img src="pass-map_files/figure-html/field_plot-1.png" width="576" /></p>
<div id="wrap-it-into-a-function" class="section level3">
<h3>Wrap it into a function</h3>
<p>We can turn this into a function so that we don’t have to copy-paste it all over the place. Note that I’m wrapping it in a list so I can use it with <code>+</code> in a sequence of <code>ggplot2</code> calls.</p>
<p>I’m also using <code>front_col</code> and <code>back_col</code> to let us switch from white on black to black on white if needed.</p>
<pre class="r"><code>add_field &lt;- function() {
  list(
    coord_cartesian(
      xlim = c(-53.333 / 2, 53.333 / 2),
      ylim = c(-15, 60)
    ),
    geom_text(
      data = annotate_df, aes(label = text, angle = rotation),
      color = front_col, size = 8
    ),
    geom_segment(
      data = yardline_df, color = front_col, size = 1,
      aes(x = x, y = y, xend = xend, yend = yend)
    ),
    geom_segment(
      x = -56 / 2, y = 0, xend = 56 / 2, yend = 0,
      color = &quot;blue&quot;, size = 1, alpha = 0.5
    ),
    geom_segment(
      data = sideline_df, color = front_col, size = 2,
      aes(x = x, y = y, xend = xend, yend = yend)
    ),
    geom_text(
      data = center_df,
      aes(label = text), color = front_col, vjust = 0.32
    ),
    theme_void(),
    theme(
      strip.text = element_text(size = 20, color = front_col),
      plot.background = element_rect(fill = back_col, color = NA),
      legend.position = &quot;none&quot;,
      plot.margin = unit(c(2, 1, 0.5, 1), unit = &quot;cm&quot;),
      plot.caption = element_text(color = front_col),
      plot.title = element_text(color = front_col),
      plot.subtitle = element_text(color = front_col),
      panel.background = element_rect(fill = back_col, color = NA),
      panel.border = element_blank()
    )
  )
}</code></pre>
</div>
<div id="qb-comparison" class="section level3">
<h3>QB Comparison</h3>
<p>First let’s filter down to just our two QBs to compare, Patrick Mahomes and Russell Wilson.</p>
<pre class="r"><code>passer_df &lt;- pass_map_df %&gt;%
  filter(str_detect(name, c(&quot;Mahomes|Russel&quot;))) %&gt;%
  mutate(name = factor(name, levels = c(&quot;Patrick Mahomes&quot;, &quot;Russell Wilson&quot;))) %&gt;%
  select(name, x_coord, y_coord)

passer_df %&gt;%
  ggplot(aes(x = x_coord, y = y_coord)) +
  geom_density2d_filled() +
  theme(legend.position = &quot;none&quot;)</code></pre>
<p><img src="pass-map_files/figure-html/create-passer-df-1.png" width="576" /></p>
<p>We’ll specify fill and color to both scale with the level/density and normal density peaks across our plots, and finally set our breaks to drop the lowest bin of passes.</p>
<pre class="r"><code>pass_map &lt;- passer_df %&gt;%
  ggplot(aes(x = x_coord, y = y_coord)) +
  geom_density_2d_filled(
    aes(fill = ..level.., color = ..level..),
    contour_var = &quot;ndensity&quot;, # normalize across facets
    breaks = seq(0.1, 1.0, length.out = 10)
  ) +
  facet_wrap(~name)

pass_map</code></pre>
<p><img src="pass-map_files/figure-html/initial-map-1.png" width="960" /></p>
<p>We can quickly add the field background to this with our function <code>add_field()</code>!</p>
<pre class="r"><code>back_col &lt;- &quot;white&quot;
front_col &lt;- &quot;black&quot;

pass_map +
  add_field()</code></pre>
<p><img src="pass-map_files/figure-html/add-field-plot-1.png" width="960" /></p>
</div>
<div id="specify-color-schemes" class="section level3">
<h3>Specify Color schemes</h3>
<p>While that’s essentially our final graph perhaps you don’t want to use <code>viridis</code> which is the default color scheme. We can generate custom color palettes or use a pre-built color palette via the <a href="https://github.com/EmilHvitfeldt/paletteer"><code>paleteer</code></a> R package. Note that the 3 color palettes I create all do essentially the same thing but it’s:</p>
<ul>
<li>Building your own custom color sequence with <code>grDevices::colorRampPalette()</code><br />
</li>
<li>Returning a pre-built palette w/ <code>paletteer::paletteer_d()</code><br />
</li>
<li>Expanding a pre-built palette to be longer with <code>colorRampPalette</code></li>
</ul>
<pre class="r"><code>heat_colors &lt;- grDevices::colorRampPalette(c(&quot;#800026FF&quot;, &quot;#FC4E2AFF&quot;, &quot;#FEB24CFF&quot;, &quot;#FFFFCCFF&quot;))(10)

heat_palette &lt;- paletteer::paletteer_d(&quot;RColorBrewer::YlOrRd&quot;, n = 9, direction = -1)

heat_colors_interpolated &lt;- colorRampPalette(paletteer::paletteer_d(&quot;RColorBrewer::YlOrRd&quot;, n = 9, direction = -1))(10)

heat_colors %&gt;% scales::show_col()</code></pre>
<p><img src="pass-map_files/figure-html/colors-1.png" width="672" /></p>
<pre class="r"><code>heat_palette %&gt;% scales::show_col()</code></pre>
<p><img src="pass-map_files/figure-html/colors-2.png" width="672" /></p>
<pre class="r"><code>heat_colors_interpolated %&gt;% scales::show_col()</code></pre>
<p><img src="pass-map_files/figure-html/colors-3.png" width="672" /></p>
<pre class="r"><code>pass_map +
  add_field() +
  scale_fill_manual(values = c(heat_colors_interpolated), aesthetics = c(&quot;fill&quot;, &quot;color&quot;))</code></pre>
<p><img src="pass-map_files/figure-html/use-colors-1.png" width="960" /></p>
<p>And also in black!</p>
<pre class="r"><code>back_col &lt;- &quot;black&quot;
front_col &lt;- &quot;white&quot;

pass_map +
  add_field() +
  scale_fill_manual(values = c(heat_colors_interpolated), aesthetics = c(&quot;fill&quot;, &quot;color&quot;))</code></pre>
<p><img src="pass-map_files/figure-html/use-colors2-1.png" width="960" /></p>
<p>Beautiful!</p>
</div>
<div id="pff_moo-style-field" class="section level3">
<h3>PFF_Moo style Field</h3>
<p><a href="https://twitter.com/PFF_Moo/status/1235681100837486592?s=20">PFF_Moo</a> takes a different approach to field lines, which can be recreated below.</p>
<pre class="r"><code>not_div_5 &lt;- function(x) {
  # select only elements of the vector not divisible by 5
  x[x %% 5 != 0]
}

center_df &lt;- tibble(
  x_coord = c(rep(-3.1, 60), rep(3.1, 60)),
  y_coord = seq(-14, 59, 1) %&gt;% rep(2) %&gt;% not_div_5(),
  text = &quot;--&quot;
)

# line labels
horiz_yd_df &lt;- tibble(
  x_coord = c(12.88, -12.88) %&gt;% rep(each = 14),
  y_coord = seq(-10, 55, 5) %&gt;% rep(2),
  text = seq(-10, 55, 5) %&gt;% rep(2)
)

# yardlines
yardline_df &lt;- tibble(
  y = seq(-15, 60, 5),
  yend = seq(-15, 60, 5),
  x = rep(-56 / 2, 16),
  xend = rep(56 / 2, 16)
)

# sidelines
sideline_df &lt;- tibble(
  y = c(-15.15, -15.15),
  yend = c(60.15, 60.15),
  x = c(-56 / 2, 56 / 2),
  xend = c(-56 / 2, 56 / 2)
)

add_moo_field &lt;- function() {
  list(
    coord_cartesian(
      xlim = c(-53.333 / 2, 53.333 / 2),
      ylim = c(-15, 60)
    ),
    geom_segment(
      data = yardline_df, color = front_col, size = 0.5,
      linetype = &quot;dashed&quot;, alpha = 0.5,
      aes(x = x, y = y, xend = xend, yend = yend)
    ),
    geom_segment(
      aes(x = -56 / 2, y = 0, xend = 56 / 2, yend = 0),
      color = &quot;blue&quot;, size = 1
    ),
    geom_segment(
      data = sideline_df, color = front_col, size = 2,
      aes(x = x, y = y, xend = xend, yend = yend)
    ),
    geom_text(
      data = center_df,
      aes(label = text), color = front_col, vjust = 0.32
    ),
    geom_text(
      data = horiz_yd_df, aes(label = text),
      color = front_col, size = 4, fontface = &quot;bold&quot;
    ),
    theme_void(),
    theme(
      strip.text = element_text(size = 20, color = front_col),
      plot.background = element_rect(fill = back_col, color = NA),
      legend.position = &quot;none&quot;,
      plot.margin = unit(c(2, 1, 0.5, 1), unit = &quot;cm&quot;),
      plot.caption = element_text(color = front_col),
      plot.title = element_text(color = front_col),
      plot.subtitle = element_text(color = front_col),
      panel.background = element_rect(fill = back_col, color = NA),
      panel.border = element_blank()
    )
  )
}

back_col &lt;- &quot;white&quot;
front_col &lt;- &quot;black&quot;


ggplot(pass_map_df, aes(x = x_coord, y = y_coord)) +
  geom_density_2d_filled(
    aes(fill = ..level..),
    contour_var = &quot;ndensity&quot;, # normalize to each QBs total passes
    breaks = seq(0.1, 1.0, length.out = 10) # drop the lowest passes
  ) +
  add_moo_field()</code></pre>
<p><img src="pass-map_files/figure-html/field_plot_moo-1.png" width="576" /></p>
</div>
</div>
</div>
<div id="tldr" class="section level1">
<h1>TLDR</h1>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
